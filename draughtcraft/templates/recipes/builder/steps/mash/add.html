<%!
  from draughtcraft.lib.units import UNITS

  hidden_fields = {
    'amount'  : '0 lb',
    'use'     : 'MASH'
  }

  def hidden(type='RecipeAddition'):
    copy = hidden_fields.copy()
    copy.update({'type': type})
    return copy

%>

<h3>Add to Mash</h3>

<form />

<fieldset>
  ${h.form('async/ingredients', hidden_fields = hidden())}
    ${h.select(
      'ingredient', 
      None, 
      [
        ('', 'Add Malt/Fermentables...')] + sorted(
          [
            (f.id, f.printed_name) for f in h.model.Fermentable.excluding(
              *[a.ingredient for a in h.request.context['recipe'].mash.get(h.model.Fermentable, [])]
            ) if f.type in ('MALT', 'GRAIN', 'ADJUNCT', 'SUGAR')
          ], key = lambda f: f[1]
        )
    )}
  ${h.end_form()}
</fieldset>

<fieldset>
  ${h.form('async/ingredients', hidden_fields = hidden())}
    ${h.select(
      'ingredient', 
      None, 
      [
        ('', 'Add Malt Extract...')] + sorted(
          [
            (f.id, f.printed_name) for f in h.model.Fermentable.excluding(
              *[a.ingredient for a in h.request.context['recipe'].mash.get(h.model.Fermentable, [])]
            ) if f.type == 'EXTRACT'
          ], key = lambda f: f[1]
        )
    )}
  ${h.end_form()}
</fieldset>

<fieldset>
  ${h.form('async/ingredients', hidden_fields = hidden('HopAddition'))}
    ${h.select(
      'ingredient', 
      None, 
      [
        ('', 'Add Hops...')] + sorted(
          [
            (hop.id, hop.printed_name) for hop in h.model.Hop.excluding(
              *[a.ingredient for a in h.request.context['recipe'].mash.get(h.model.Hop, [])]
            )
          ], key = lambda f: f[1]
        )
    )}
  ${h.end_form()}
</fieldset>

<fieldset>
  ${h.form('async/ingredients', hidden_fields = hidden())}
    ${h.select(
      'ingredient', 
      None, 
      [
        ('', 'Add Misc...')] + sorted(
          [
            (extra.id, extra.printed_name) for extra in h.model.Extra.excluding(
              *[a.ingredient for a in h.request.context['recipe'].mash.get(h.model.Extra, [])]
            )
          ], key = lambda f: f[1]
        )
    )}
  ${h.end_form()}
</fieldset>
